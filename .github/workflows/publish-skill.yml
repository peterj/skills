# Required repository secrets:
#   AGENTREGISTRY_URL - Base URL of the agent registry API (e.g., https://registry.example.com)

name: Publish skill to registry

on:
  pull_request:
    types: [closed]

jobs:
  publish:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout merged code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect and publish changed skills
        env:
          AGENTREGISTRY_URL: ${{ secrets.AGENTREGISTRY_URL }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail

          # Find all skill directories that were changed in this PR
          CHANGED_FILES=$(git diff --name-only "${{ github.event.pull_request.base.sha }}" "${{ github.event.pull_request.merge_commit_sha }}" || true)

          # Extract unique skill directory names from changed files
          SKILL_DIRS=$(echo "$CHANGED_FILES" | grep '^skills/' | cut -d'/' -f2 | sort -u)

          if [ -z "$SKILL_DIRS" ]; then
            echo "No skill directories changed in this PR."
            exit 0
          fi

          for SKILL_NAME in $SKILL_DIRS; do
            SKILL_DIR="skills/$SKILL_NAME"
            REF_FILE="$SKILL_DIR/ref.json"
            SKILL_FILE="$SKILL_DIR/SKILL.md"

            if [ ! -f "$REF_FILE" ]; then
              echo "Skipping $SKILL_NAME: no ref.json found"
              continue
            fi

            if [ ! -f "$SKILL_FILE" ]; then
              echo "Skipping $SKILL_NAME: no SKILL.md found"
              continue
            fi

            echo "Publishing skill: $SKILL_NAME"

            # Extract metadata from ref.json
            TITLE=$(jq -r '.skill.title // empty' "$REF_FILE")
            CATEGORY=$(jq -r '.skill.category // empty' "$REF_FILE")
            SOURCE_URL=$(jq -r '.source.url // empty' "$REF_FILE")
            SOURCE_TYPE=$(jq -r '.source.type // empty' "$REF_FILE")
            GITHUB_OWNER=$(jq -r '.source.github.owner // empty' "$REF_FILE")
            GITHUB_REPO=$(jq -r '.source.github.repo // empty' "$REF_FILE")
            COMMIT_SHA=$(jq -r '.source.github.commitSha // empty' "$REF_FILE")
            PUBLISHER=$(jq -r '.publisher.login // empty' "$REF_FILE")
            GENERATED_AT=$(jq -r '.generatedAt // empty' "$REF_FILE")
            MODEL=$(jq -r '.model // empty' "$REF_FILE")

            # Extract description from SKILL.md frontmatter
            DESCRIPTION=$(awk '/^---$/{n++; next} n==1{print} n==2{exit}' "$SKILL_FILE" | grep '^description:' | sed 's/^description: *//' | sed 's/^"//;s/"$//')

            # Determine version from ref.json files list or default
            VERSION=$(jq -r '.skill.files | length | tostring' "$REF_FILE" 2>/dev/null || echo "1.0.0")
            # Try to get version from PR branch name or default to 1.0.0
            VERSION="1.0.0"

            # Build the repository URL for the skill in this repo
            REPO_URL="https://github.com/${GITHUB_REPOSITORY}/tree/main/skills/${SKILL_NAME}"

            # Build the JSON payload matching SkillJSON schema
            PAYLOAD=$(jq -n \
              --arg name "$SKILL_NAME" \
              --arg description "${DESCRIPTION:-"A skill generated from $SOURCE_URL"}" \
              --arg version "$VERSION" \
              --arg title "${TITLE:-$SKILL_NAME}" \
              --arg category "${CATEGORY:-}" \
              --arg status "published" \
              --arg websiteUrl "${SOURCE_URL:-}" \
              --arg repoUrl "$REPO_URL" \
              --arg repoSource "github" \
              --arg sourceType "$SOURCE_TYPE" \
              --arg sourceUrl "$SOURCE_URL" \
              --arg commitSha "$COMMIT_SHA" \
              --arg publisher "$PUBLISHER" \
              --arg generatedAt "$GENERATED_AT" \
              --arg model "$MODEL" \
              '{
                name: $name,
                description: $description,
                version: $version,
                title: (if $title != "" then $title else null end),
                category: (if $category != "" then $category else null end),
                status: $status,
                websiteUrl: (if $websiteUrl != "" then $websiteUrl else null end),
                repository: {
                  url: $repoUrl,
                  source: $repoSource
                }
              } | with_entries(select(.value != null))')

            echo "Payload: $PAYLOAD"

            # POST to the agent registry
            HTTP_STATUS=$(curl -s -o /tmp/response.json -w "%{http_code}" \
              -X POST \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" \
              "${AGENTREGISTRY_URL}/v0/skills")

            if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
              echo "Successfully published $SKILL_NAME (HTTP $HTTP_STATUS)"
              cat /tmp/response.json
            else
              echo "Failed to publish $SKILL_NAME (HTTP $HTTP_STATUS)"
              cat /tmp/response.json
              exit 1
            fi

            echo "---"
          done
